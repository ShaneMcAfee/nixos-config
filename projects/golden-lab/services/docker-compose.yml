services:
  caddy:
    build: .
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443/tcp"
      - "443:443/udp"
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./caddy_data:/data
      - ./caddy_config:/config
    command: ["/bin/sh", "-c", "sleep 10 && caddy run --config /etc/caddy/Caddyfile --adapter caddyfile"]
    networks:
      - caddy

  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}
      - VPN_TYPE=${VPN_TYPE}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=United States
      - TZ=${TZ}
      # Removed PORT_FORWARD_ONLY to ensure connectivity first
    ports:
      - "${QBITTORRENT_WEBUI_PORT}:${QBITTORRENT_WEBUI_PORT}"
      - 8080:8080
    volumes:
      - ./gluetun:/gluetun
    networks:
      - caddy

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    network_mode: service:gluetun
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=${QBITTORRENT_WEBUI_PORT}
    volumes:
      - ${APPDATA_PATH}/qbittorrent:/config
      - ${DOWNLOADS_PATH}/incomplete:/incomplete
      - ${DATA_PATH}:/data
    depends_on:
      gluetun:
        condition: service_healthy

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${APPDATA_PATH}/prowlarr:/config
    networks:
      - caddy
    labels:
      caddy: prowlarr.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9696}}"

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${APPDATA_PATH}/sonarr:/config
      - ${DATA_PATH}:/data
    networks:
      - caddy
    labels:
      caddy: sonarr.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8989}}"

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${APPDATA_PATH}/radarr:/config
      - ${DATA_PATH}:/data
    networks:
      - caddy
    labels:
      caddy: radarr.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 7878}}"

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - PIHOLE_DNS=unbound#5335
    volumes:
      - ${APPDATA_PATH}/pihole/pihole:/etc/pihole
      - ${APPDATA_PATH}/pihole/dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    networks:
      - caddy
    depends_on:
      - unbound
    labels:
      caddy: pihole.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"

  unbound:
    image: mvance/unbound:latest
    container_name: unbound
    restart: unless-stopped
    hostname: unbound
    volumes:
      - ./unbound-conf:/opt/unbound/etc/unbound
    networks:
      - caddy

  devops-controller:
    image: python:3.11-slim
    container_name: devops-controller
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/workspace
    command: ["sh", "-c", "echo 'AI Agent Started' && tail -f /dev/null"]
    networks:
      - caddy

networks:
  caddy:
    name: caddy
  proxy:
    external: true
